name: CD Release (Windows)

on:
    push:
        tags:
            - "v*" # more reliable than v*.*.*
    workflow_dispatch: # manual trigger for testing

permissions:
    contents: write
    packages: write

concurrency:
    group: release-${{ github.ref }}
    cancel-in-progress: false

jobs:
    windows-release:
        name: Release (download CI artifact + GitHub Release + Windows Docker)
        runs-on: windows-2022

        steps:
            # 1) Download the Windows artifact built by CI for the same commit as the tag
            - name: Download Windows artifact from CI (same commit)
              uses: dawidd6/action-download-artifact@v3
              with:
                  workflow: ci.yml
                  commit: ${{ github.sha }}
                  name: falcata-win64
                  path: artifact
                  if_no_artifact_found: fail

            - name: Show downloaded files
              shell: pwsh
              run: |
                  Get-ChildItem artifact -Recurse | Select-Object FullName, Length

            # 2) Create GitHub Release + upload the Windows zip asset
            - name: Create GitHub Release + upload asset
              uses: softprops/action-gh-release@v2
              with:
                  generate_release_notes: true
                  files: |
                      artifact/**

            # 3) Checkout repo (needed to build Docker image)
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # 4) Prepare dist/ from artifact (zip -> dist)
            - name: Extract artifact into dist/
              shell: pwsh
              run: |
                  New-Item -ItemType Directory -Force dist | Out-Null

                  $zip = Get-ChildItem artifact -Recurse -Filter *.zip | Select-Object -First 1
                  if (-not $zip) { throw "No .zip found in artifact/. CI must upload a zip (e.g. Falcata-win64.zip)." }

                  Expand-Archive -Path $zip.FullName -DestinationPath dist -Force

                  Write-Host "dist content:"
                  Get-ChildItem dist -Recurse | Select-Object FullName

                  $exe = Get-ChildItem dist -Recurse -Filter WebServer.exe | Select-Object -First 1
                  if (-not $exe) { throw "WebServer.exe not found inside dist/. Ensure CI zip contains WebServer.exe." }

            # 5) Login to GHCR
            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            # 6) Build + push Windows container image (from Dockerfile.windows)
            - name: Build & push Windows Docker image
              shell: pwsh
              run: |
                  $image = ("ghcr.io/${{ github.repository }}").ToLower()
                  $tag   = "${{ github.ref_name }}"

                  if (-not (Test-Path "Dockerfile.windows")) {
                    throw "Dockerfile.windows is missing. Add it at repo root (see template below)."
                  }

                  docker build -f Dockerfile.windows -t "$image:$tag-windows" -t "$image:windows-latest" .
                  docker push "$image:$tag-windows"
                  docker push "$image:windows-latest"

    deploy:
        name: Deploy on Docker machine (optional)
        runs-on: windows-2022
        needs: windows-release
        if: ${{ vars.DEPLOY_HOST != '' }}

        steps:
            - name: Deploy via SSH (docker compose pull + up)
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ vars.DEPLOY_HOST }}
                  username: ${{ secrets.DEPLOY_USER }}
                  key: ${{ secrets.DEPLOY_SSH_KEY }}
                  script: |
                      set -e
                      cd "${{ vars.DEPLOY_PATH }}"
                      docker compose pull
                      docker compose up -d --remove-orphans
