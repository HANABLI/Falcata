name: CD Release

on:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write
    packages: write

concurrency:
    group: release-${{ github.ref }}
    cancel-in-progress: false

jobs:
    download-binaries:
        name: Download binaries from CI
        runs-on: ubuntu-22.04
        outputs:
            has_win: ${{ steps.check.outputs.has_win }}
            has_linux: ${{ steps.check.outputs.has_linux }}

        steps:
            - name: Download Windows artifact from CI (same commit)
              id: dl_win
              uses: dawidd6/action-download-artifact@v3
              with:
                  # IMPORTANT: must match your CI workflow file name or workflow name
                  # Examples: "ci.yml" OR "CI" OR "CI-CD"
                  workflow: ci.yml

                  # download artifact produced for the same commit sha as this tag
                  commit: ${{ github.sha }}

                  # IMPORTANT: must match artifact name used in CI
                  name: falcata-win64
                  path: dist/win

                  # Fail the job if not found (CD relies on CI output)
                  if_no_artifact_found: fail

            # OPTIONAL: if you also build linux binary in CI, keep this.
            - name: Download Linux artifact from CI (same commit) (optional)
              id: dl_linux
              continue-on-error: true
              uses: dawidd6/action-download-artifact@v3
              with:
                  workflow: ci.yml
                  commit: ${{ github.sha }}
                  name: falcata-linux
                  path: dist/linux
                  if_no_artifact_found: ignore

            - name: Check what we have
              id: check
              shell: bash
              run: |
                  set -e
                  if ls dist/win/* >/dev/null 2>&1; then echo "has_win=true" >> $GITHUB_OUTPUT; else echo "has_win=false" >> $GITHUB_OUTPUT; fi
                  if ls dist/linux/* >/dev/null 2>&1; then echo "has_linux=true" >> $GITHUB_OUTPUT; else echo "has_linux=false" >> $GITHUB_OUTPUT; fi
                  echo "Windows files:"; ls -la dist/win || true
                  echo "Linux files:"; ls -la dist/linux || true

            - name: Upload as workflow artifact (for next jobs)
              uses: actions/upload-artifact@v4
              with:
                  name: release-dist
                  path: dist

    github-release:
        name: Create GitHub Release + upload assets
        runs-on: ubuntu-22.04
        needs: download-binaries

        steps:
            - name: Download dist bundle from previous job
              uses: actions/download-artifact@v4
              with:
                  name: release-dist
                  path: dist

            - name: Create GitHub Release and upload assets
              uses: softprops/action-gh-release@v2
              with:
                  generate_release_notes: true
                  files: |
                      dist/win/**
                      dist/linux/**

    docker-publish:
        name: Docker build & push (GHCR)
        runs-on: ubuntu-22.04
        needs: github-release

        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build & push
              shell: bash
              run: |
                  IMAGE="ghcr.io/${GITHUB_REPOSITORY,,}"
                  TAG="${GITHUB_REF_NAME}"
                  docker build -t "${IMAGE}:${TAG}" -t "${IMAGE}:latest" .
                  docker push "${IMAGE}:${TAG}"
                  docker push "${IMAGE}:latest"

    deploy:
        name: Deploy on Docker machine (optional)
        runs-on: ubuntu-22.04
        needs: docker-publish
        if: ${{ vars.DEPLOY_HOST != '' }}

        steps:
            - name: Deploy via SSH (docker compose pull + up)
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ vars.DEPLOY_HOST }}
                  username: ${{ secrets.DEPLOY_USER }}
                  key: ${{ secrets.DEPLOY_SSH_KEY }}
                  script: |
                      set -e
                      cd "${{ vars.DEPLOY_PATH }}"
                      docker compose pull
                      docker compose up -d --remove-orphans
