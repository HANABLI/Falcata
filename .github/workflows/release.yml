name: CD Release (Windows)

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

permissions:
    contents: write
    packages: write

concurrency:
    group: release-${{ github.ref }}
    cancel-in-progress: false

jobs:
    windows-release:
        name: Build Release + GH Release + Windows Docker
        runs-on: windows-2022

        steps:
            - name: Checkout repository (needed for Docker build context)
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  submodules: recursive

            - name: Download Windows artifact from CI (same commit)
              uses: dawidd6/action-download-artifact@v3
              with:
                  workflow: ci.yml
                  commit: ${{ github.sha }}
                  name: falcata-win64
                  path: artifact
                  if_no_artifact_found: fail

            - name: Extract artifact zip into dist/
              shell: pwsh
              run: |
                  $ErrorActionPreference = "Stop"

                  New-Item -ItemType Directory -Force dist | Out-Null

                  $zip = Get-ChildItem artifact -Recurse -Filter *.zip -ErrorAction SilentlyContinue | Select-Object -First 1
                  if (-not $zip) { throw "No .zip found in artifact/. CI must upload a zip (e.g. Falcata-win64.zip)." }

                  Expand-Archive -Path $zip.FullName -DestinationPath dist -Force

                  Write-Host "dist content:"
                  Get-ChildItem dist -Recurse | Select-Object FullName, Length

                  $exe = Get-ChildItem dist -Recurse -Filter WebServer.exe -ErrorAction SilentlyContinue | Select-Object -First 1
                  if (-not $exe) { throw "WebServer.exe not found inside dist/. Ensure CI zip contains WebServer.exe." }

            - name: Create GitHub Release + upload zip asset
              uses: softprops/action-gh-release@v2
              with:
                  generate_release_notes: true
                  files: |
                      artifact/**

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build & push Windows Docker image
              shell: pwsh
              run: |
                  $ErrorActionPreference = "Stop"

                  $image = ("ghcr.io/${{ github.repository }}").ToLower()
                  $tag   = "${{ github.ref_name }}"

                  if (-not (Test-Path "Dockerfile.windows")) {
                    throw "Dockerfile.windows is missing at repo root."
                  }

                  docker version

                  docker build -f Dockerfile.windows `
                  -t "${image}:${tag}-windows" `
                  -t "${image}:windows-latest" `
                  .

                  docker push "${image}:${tag}-windows"
                  docker push "${image}:windows-latest"

    deploy:
        name: Deploy on self-hosted Windows runner
        needs: windows-release
        runs-on: [self-hosted, windows, x64, azure-prod]
        environment: secrets

        permissions:
            contents: read
            packages: read

        # IMPORTANT: bypass ExecutionPolicy + no pwsh dependency
        defaults:
            run:
                shell: powershell -NoProfile -ExecutionPolicy Bypass -Command "{0}"

        steps:
            - name: Checkout repository (to get compose + config)
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: Prepare runtime files on target (DEPLOY_PATH)
              env:
                  DEPLOY_PATH: ${{ vars.DEPLOY_PATH }} # C:\opt\falcata
                  JWT_SECRET: ${{ secrets.JWT_SECRET }}
                  PG_CONNINFO: ${{ secrets.PG_CONNINFO }}
              run: |
                  $ErrorActionPreference = "Stop"

                  $deployPath = $env:DEPLOY_PATH
                  New-Item -ItemType Directory -Force -Path $deployPath | Out-Null
                  New-Item -ItemType Directory -Force -Path (Join-Path $deployPath "config") | Out-Null

                  # Write .env in DEPLOY_PATH (docker compose auto-loads it)
                  $envFile = Join-Path $deployPath ".env"
                  @"
                  JWT_SECRET=$($env:JWT_SECRET)
                  PG_CONNINFO=$($env:PG_CONNINFO)
                  "@ | Set-Content -Path $envFile -Encoding ASCII

                  # Copy compose + config from the repo to DEPLOY_PATH
                  Copy-Item -Force ".\docker-compose.windows.yml" (Join-Path $deployPath "docker-compose.windows.yml")
                  Copy-Item -Force ".\config\config.prod.json" (Join-Path $deployPath "config\config.prod.json")

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Pull & restart (docker compose)
              env:
                  DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}
              run: |
                  $ErrorActionPreference = "Stop"

                  $img = ("ghcr.io/${{ github.repository }}").ToLower()
                  $tag = "${{ github.ref_name }}"

                  docker pull "$img:$tag-windows"

                  Set-Location $env:DEPLOY_PATH

                  # Force compose to use the exact tag image (recommended)
                  $env:FALCATA_IMAGE = "$img:$tag-windows"

                  docker compose -f docker-compose.windows.yml up -d --remove-orphans
                  docker ps
