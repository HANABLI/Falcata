name: Release

on:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write
    packages: write

jobs:
    # 1) Build Windows release binary and upload as a Release asset
    windows-binary:
        name: Windows Release (MSVC)
        runs-on: windows-2022

        steps:
            - name: Checkout (with submodules)
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Setup Ninja
              uses: seanmiddleditch/gha-setup-ninja@v5

            - name: MSVC Dev Cmd
              uses: ilammy/msvc-dev-cmd@v1

            - name: Configure (Release)
              run: |
                  cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

            - name: Build
              run: |
                  cmake --build build --parallel

            # Optional: run tests in Release too
            - name: Test
              run: |
                  cd build
                  ctest --output-on-failure -C Release

            - name: Package artifact
              shell: pwsh
              run: |
                  New-Item -ItemType Directory -Force -Path dist | Out-Null
                  $tag = "${{ github.ref_name }}"
                  # Your top-level CMake sets runtime output to build/ (binary likely in build\WebServer.exe or build\WebServer\WebServer.exe depending on submodule)
                  # Adjust the path below if needed after first run:
                  $binCandidates = @(
                    "build\WebServer.exe",
                    "build\WebServer\WebServer.exe",
                    "build\bin\WebServer.exe"
                  )
                  $bin = $binCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
                  if (-not $bin) { throw "WebServer.exe not found in expected locations: $($binCandidates -join ', ')" }

                  Copy-Item $bin -Destination "dist\WebServer.exe" -Force

                  # Ship config example (optional)
                  if (Test-Path "config.json") { Copy-Item "config.json" "dist\config.example.json" -Force }

                  Compress-Archive -Path dist\* -DestinationPath "Falcata-${tag}-win64.zip" -Force

            - name: Upload Release asset (Windows zip)
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      Falcata-${{ github.ref_name }}-win64.zip

    # 2) Create GitHub Release notes (once)
    github-release:
        name: Create GitHub Release
        runs-on: ubuntu-22.04
        needs: windows-binary
        steps:
            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  generate_release_notes: true

    # 3) Build + push Docker image (Linux)
    docker-build-push:
        name: Docker build & push (GHCR)
        runs-on: ubuntu-22.04
        needs: github-release

        steps:
            - name: Checkout (with submodules)
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build image
              run: |
                  IMAGE="ghcr.io/${{ github.repository }}"
                  docker build \
                    -t "${IMAGE}:${{ github.ref_name }}" \
                    -t "${IMAGE}:latest" \
                    .

            - name: Push image
              run: |
                  IMAGE="ghcr.io/${{ github.repository }}"
                  docker push "${IMAGE}:${{ github.ref_name }}"
                  docker push "${IMAGE}:latest"

    # 4) Optional: deploy to your Docker machine via SSH (only if secrets exist)
    deploy:
        name: Deploy (docker compose pull + up)
        runs-on: ubuntu-22.04
        needs: docker-build-push
        if: ${{ secrets.DEPLOY_HOST != '' }}

        steps:
            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.DEPLOY_HOST }}
                  username: ${{ secrets.DEPLOY_USER }}
                  key: ${{ secrets.DEPLOY_SSH_KEY }}
                  script: |
                      set -e
                      cd ${{ secrets.DEPLOY_PATH }}
                      docker compose pull
                      docker compose up -d --remove-orphans
